<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNL Learning Assistant Feedback System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FDF2D9 0%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info.hidden {
            display: none;
        }

        .user-welcome {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .tab-container {
            display: flex;
            border-bottom: 3px solid #f0f0f0;
            margin-bottom: 30px;
            margin-top: 60px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }

        .tab.active {
            background: #dc143c;
            color: white;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        select,
        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #dc143c;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 20, 60, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .feedback-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .feedback-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .feedback-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .feedback-meta {
            font-size: 14px;
            color: #666;
        }

        .feedback-content {
            line-height: 1.6;
            color: #333;
        }

        .rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            font-size: 20px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star.filled {
            color: #ffc107;
        }

        .star:hover {
            color: #ffc107;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc143c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Learning Assistant Feedback System</h1>
            <p>Computer Science & Computer Engineering - University of Nebraska-Lincoln</p>
        </div>

        <div class="main-content">
            <!-- User Info Section -->
            <div id="user-info" class="user-info hidden">
                <div class="user-welcome">
                    Welcome, <span id="user-name"></span>!
                </div>
                <button id="logout-btn" class="btn btn-secondary">Log Out</button>
            </div>

            <div class="tab-container">
                <button class="tab active" onclick="showTab('student')">Feedback</button>
                <button class="tab" onclick="showTab('login')">Login</button>
                <button class="tab hidden" id="dashboard-tab" onclick="showTab('dashboard')">Dashboard</button>
            </div>

            <!-- Student Feedback Tab -->
            <div id="student" class="tab-content active">
                <h2>Submit Feedback</h2>
                <form id="feedback-form">
                    <div class="form-group">
                        <label for="course">Course:</label>
                        <select id="course" required>
                            <option value="">Select Course</option>
                            <option value="CSCE 101">CSCE 101 - Intro to Computer Science</option>
                            <option value="CSCE 155A">CSCE 155A - Computer Science I (Python)</option>
                            <option value="CSCE 155E">CSCE 155E - Computer Science I (C)</option>
                            <option value="CSCE 155H">CSCE 155H - Computer Science I Honors</option>
                            <option value="CSCE 155N">CSCE 155N - Computer Science I (Matlab)</option>
                            <option value="CSCE 156">CSCE 156 - Computer Science II</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="feedback-type">Feedback Type:</label>
                        <select id="feedback-type" required>
                            <option value="">Select Type</option>
                            <option value="TA Performance">Teaching Assistant Performance</option>
                            <option value="Learning Resources">Learning Resources</option>
                            <option value="Lab Sessions">Lab Sessions</option>
                            <option value="Office Hours">Office Hours</option>
                            <option value="General Suggestion">General Suggestion</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rating">Overall Rating:</label>
                        <div class="rating">
                            <span class="star" data-rating="1">★</span>
                            <span class="star" data-rating="2">★</span>
                            <span class="star" data-rating="3">★</span>
                            <span class="star" data-rating="4">★</span>
                            <span class="star" data-rating="5">★</span>
                        </div>
                        <input type="hidden" id="rating-value" value="0">
                    </div>

                    <div class="form-group">
                        <label for="feedback-text">Feedback Details:</label>
                        <textarea id="feedback-text" placeholder="Please provide detailed feedback..."
                            required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="student-name">Your Name (Optional):</label>
                        <input type="text" id="student-name" placeholder="Leave blank to stay anonymous">
                    </div>

                    <div class="form-group">
                        <label for="student-year">Academic Year:</label>
                        <select id="student-year">
                            <option value="">Select Year (Optional)</option>
                            <option value="Freshman">Freshman</option>
                            <option value="Sophomore">Sophomore</option>
                            <option value="Junior">Junior</option>
                            <option value="Senior">Senior</option>
                            <option value="Graduate">Graduate Student</option>
                        </select>
                    </div>

                    <button type="submit" class="btn" id="submit-feedback-btn">Submit Feedback</button>
                </form>
            </div>

            <!-- Login Tab -->
            <div id="login" class="tab-content">
                <div class="login-form">
                    <h2 style="text-align: center; margin-bottom: 30px;">Login with NUID</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="nuid">NUID:</label>
                            <input type="text" id="nuid" placeholder="Enter your NUID" required>
                        </div>
                        <button type="submit" class="btn" id="login-btn" style="width: 100%;">Login</button>
                    </form>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <h2>Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-feedback">0</div>
                        <div>Total Feedback</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-rating">0.0</div>
                        <div>Average Rating</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="this-week">0</div>
                        <div>This Week</div>
                    </div>
                </div>

                <div style="margin: 30px 0;">
                    <h3>Submit Your Feedback</h3>
                    <form id="user-feedback-form">
                        <div class="form-group">
                            <label for="user-feedback-type">Feedback Type:</label>
                            <select id="user-feedback-type" required>
                                <option value="">Select Type</option>
                                <option value="Staff Performance">Staff Performance</option>
                                <option value="Program Suggestion">Program Suggestion</option>
                                <option value="Resource Request">Resource Request</option>
                                <option value="General Comment">General Comment</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="user-feedback-text">Comments/Suggestions:</label>
                            <textarea id="user-feedback-text" placeholder="Your feedback..." required></textarea>
                        </div>
                        <button type="submit" class="btn" id="submit-user-feedback-btn">Submit</button>
                    </form>
                </div>

                <div class="form-group">
                    <label for="filter-course">Filter by Course:</label>
                    <select id="filter-course">
                        <option value="">All Courses</option>
                        <option value="CSCE 101">CSCE 101</option>
                        <option value="CSCE 155A">CSCE 155A</option>
                        <option value="CSCE 155E">CSCE 155E</option>
                        <option value="CSCE 155H">CSCE 155H</option>
                        <option value="CSCE 155N">CSCE 155N</option>
                        <option value="CSCE 156">CSCE 156</option>
                    </select>
                </div>

                <div id="all-feedback">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading feedback...</p>
                    </div>
                </div>
            </div>

            <div id="alert-container"></div>
        </div>
    </div>

    
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  // === Paste your Supabase values ===
  const SUPABASE_URL = "https://wmeijbsvlnjvnhptudfh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZWlqYnN2bG5qdm5ocHR1ZGZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDQ5NzksImV4cCI6MjA3MTM4MDk3OX0.YT_435s_FFsqNJs6M_yW9iIGzxeCu1BHpPVH1cwJlX8";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Global state
  let feedbackData = [];
  let currentUser = null; // { nuid, name, role: 'A'|'Staff' } when staff logs in

  // --- Helpers ---
  function showAlert(message, type = 'success') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    const container = document.querySelector('.container');
    container.insertBefore(alert, container.firstChild);
    setTimeout(() => alert.remove(), 4500);
  }

  // Tab switching (works with your inline onclick="showTab('...')")
  function showTab(tabName, clickedElement = null) {
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

    const target = document.getElementById(tabName);
    if (target) target.classList.add('active');

    // keep the clicked tab highlighted
    if (clickedElement) {
      clickedElement.classList.add('active');
    } else {
      document.querySelectorAll('.tab').forEach(tab => {
        if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(tabName)) {
          tab.classList.add('active');
        }
      });
    }

    if (tabName === 'dashboard') loadFeedback();
  }
  window.showTab = showTab;

  // --- Supabase functions ---
  async function loginUser(nuid) {
    try {
      const { data, error } = await supabase
        .from('staff')
        .select('nuid,name,role')
        .eq('nuid', nuid)
        .maybeSingle();
      if (error) throw error;
      if (!data) return { success: false, message: 'Invalid NUID' };
      return { success: true, user: data };
    } catch (err) {
      console.error(err);
      return { success: false, message: 'Login error' };
    }
  }

  async function loadFeedback() {
    try {
      const { data, error } = await supabase
        .from('feedback')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) throw error;
      feedbackData = data || [];
      updateDashboard();
    } catch (err) {
      console.error('Failed to load feedback:', err);
      showAlert(`Failed to load feedback: ${err.message}`, 'error');
      feedbackData = [];
      updateDashboard();
    }
  }

  async function submitFeedbackRow(payload, tryWithId = true) {
    // try including id_entered if present in payload
    const { error } = await supabase.from('feedback').insert(payload);
    if (!error) return;
    // if the column id_entered doesn't exist, retry without it
    const msg = String(error.message || '');
    if (tryWithId && msg.includes('id_entered')) {
      const { id_entered, ...rest } = payload;
      const r2 = await supabase.from('feedback').insert(rest);
      if (r2.error) throw r2.error;
    } else {
      throw error;
    }
  }

  // --- Wire up existing UI ---
  // Rating stars
  document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function () {
      const rating = parseInt(this.dataset.rating);
      const hidden = document.getElementById('rating-value');
      hidden.value = rating;
      document.querySelectorAll('.star').forEach((s, index) => {
        if (index < rating) s.classList.add('filled'); else s.classList.remove('filled');
      });
    });
  });

  // Student feedback form (NO LOGIN REQUIRED)
  document.getElementById('feedback-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submit-feedback-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    const feedback = {
      course: document.getElementById('course').value || null,
      type: document.getElementById('feedback-type').value,
      rating: parseInt(document.getElementById('rating-value').value) || null,
      text: document.getElementById('feedback-text').value,
      year: document.getElementById('student-year').value || null,
      submitter: (document.getElementById('student-name').value || (currentUser?.name) || 'Anonymous')
    };

    if (!feedback.type || !feedback.text) {
      showAlert('Please select a type and enter feedback text.', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Feedback';
      return;
    }
    if (!feedback.rating) {
      showAlert('Please provide a rating.', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Feedback';
      return;
    }

    try {
      // include id_entered only if someone is logged in
      const payload = currentUser ? { ...feedback, id_entered: currentUser.nuid || currentUser.id } : feedback;
      await submitFeedbackRow(payload);
      showAlert('Feedback submitted successfully!', 'success');
      this.reset();
      document.querySelectorAll('.star').forEach(s => s.classList.remove('filled'));
      document.getElementById('rating-value').value = 0;
    } catch (error) {
      console.error(error);
      showAlert('Failed to submit feedback. Please try again.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Feedback';
    }
  });

  // Login form (staff detection; students can ignore login)
  document.getElementById('login-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const loginBtn = document.getElementById('login-btn');
    loginBtn.disabled = true;
    loginBtn.textContent = 'Logging in...';

    const nuid = document.getElementById('nuid').value.trim();

    if (!/^\d{8}$/.test(nuid)) {
      showAlert('Please enter a valid 8-digit NUID', 'error');
      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
      return;
    }

    try {
      const response = await loginUser(nuid);
      if (response.success) {
        currentUser = { nuid: response.user.nuid, name: response.user.name, role: response.user.role || 'A' };
        showAlert(`Welcome, ${currentUser.name}!`, 'success');

        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('dashboard-tab').classList.remove('hidden');

        showTab('dashboard');
        await loadFeedback();

        this.reset();
      } else {
        showAlert(response.message || 'Invalid NUID', 'error');
      }
    } catch (error) {
      showAlert('Login failed. Please try again.', 'error');
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
    }
  });

  // Logout
  document.getElementById('logout-btn').addEventListener('click', function () {
    currentUser = null;
    document.getElementById('user-info').classList.add('hidden');
    document.getElementById('dashboard-tab').classList.add('hidden');
    showTab('student');
    showAlert('You have been logged out successfully.', 'success');
  });

  // Staff "user feedback" form inside dashboard
  const userFbForm = document.getElementById('user-feedback-form');
  if (userFbForm) {
    userFbForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const btn = document.getElementById('submit-user-feedback-btn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';
      const fb = {
        type: document.getElementById('user-feedback-type').value,
        text: document.getElementById('user-feedback-text').value,
        submitter: currentUser?.name || 'Anonymous',
        course: null,
        rating: null
      };
      try {
        await submitFeedbackRow(fb);
        showAlert('Feedback submitted successfully!', 'success');
        this.reset();
        loadFeedback(); // refresh dashboard list
      } catch (err) {
        showAlert('Failed to submit feedback.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Submit';
      }
    });
  }

  // Dashboard rendering
  function updateDashboard() {
    const totalFeedback = feedbackData.length || 0;
    const ratings = feedbackData.map(f => Number(f.rating || 0)).filter(Boolean);
    const avgRating = ratings.length ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : "0.0";

    const now = new Date();
    const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
    const thisWeek = feedbackData.filter(item => {
      if (!item.created_at) return false;
      const created = new Date(item.created_at);
      return created >= oneWeekAgo;
    }).length;

    document.getElementById('total-feedback').textContent = totalFeedback;
    document.getElementById('avg-rating').textContent = avgRating;
    document.getElementById('this-week').textContent = thisWeek;

    // Course filter
    const filterCourse = document.getElementById('filter-course').value;
    const rows = feedbackData.filter(fb => (filterCourse ? fb.course === filterCourse : true));

    const listEl = document.getElementById('all-feedback');
    listEl.innerHTML = '';

    if (!rows.length) {
      listEl.innerHTML = '<p style="text-align:center; color: #666; padding: 40px;">No feedback available.</p>';
      return;
    }

    rows.forEach(item => {
      const card = document.createElement('div');
      card.className = 'feedback-card';

      const header = document.createElement('div');
      header.className = 'feedback-header';

      const title = document.createElement('div');
      title.className = 'feedback-title';
      title.textContent = item.type || 'General';

      const meta = document.createElement('div');
      meta.className = 'feedback-meta';
      const dateStr = item.created_at ? new Date(item.created_at).toLocaleString() : '';
      meta.textContent = `${dateStr} • ${item.submitter || 'Anonymous'}`;

      header.appendChild(title);
      header.appendChild(meta);

      const content = document.createElement('div');
      content.className = 'feedback-content';
      content.textContent = item.text || '';

      card.appendChild(header);
      card.appendChild(content);

      if (item.rating) {
        const rating = document.createElement('div');
        rating.className = 'feedback-rating';
        rating.textContent = `Rating: ${item.rating}/5`;
        card.appendChild(rating);
      }

      if (item.course) {
        const course = document.createElement('div');
        course.className = 'feedback-course';
        course.textContent = `Course: ${item.course}`;
        card.appendChild(course);
      }

      listEl.appendChild(card);
    });
  }

  // Filters
  const filterCourseEl = document.getElementById('filter-course');
  if (filterCourseEl) filterCourseEl.addEventListener('change', updateDashboard);

  // Default tab = Student Feedback (already active in your HTML)
  // No need to call showTab here; leaving as-is ensures it opens on the feedback form.
  window.addEventListener('load', () => {
    console.log('Unified Feedback App Initialized');
  });
</script>

</body>

</html>