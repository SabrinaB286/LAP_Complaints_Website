<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNL Learning Assistant Feedback System</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f6f7fb;
      color: #222;
    }

    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
      color: #fff;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .main-content {
      padding: 32px;
    }

    .user-info {
      display: none;
      justify-content: space-between;
      align-items: center;
      background: #f1f3f6;
      border: 1px solid #e3e6eb;
      padding: 10px 14px;
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .btn {
      background: #dc143c;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(220, 20, 60, .25);
    }

    .btn-secondary {
      background: #666;
    }

    .btn-ghost {
      background: transparent;
      color: #dc143c;
      border: 1px solid #dc143c;
    }

    .tab-container {
      display: flex;
      gap: 10px;
      margin: 18px 0 20px;
    }

    .tab {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid #eee;
      background: #fff;
      cursor: pointer;
      transition: .2s;
    }

    .tab.active {
      background: #dc143c;
      color: #fff;
      transform: translateY(-2px);
    }

    .tab-content {
      display: none;
      animation: fadeIn .35s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .stat-card {
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 14px;
      background: #fafafa;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
    }

    .form-group {
      margin: 12px 0;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
    }

    textarea {
      min-height: 110px;
    }

    details {
      margin-top: 10px;
    }

    .feedback-list {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .feedback-card {
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fff;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .03);
    }

    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .feedback-meta {
      font-size: .9rem;
      color: #666;
    }

    .feedback-content {
      line-height: 1.5;
      color: #333;
      margin-top: 6px;
    }

    .rating {
      display: flex;
      gap: 6px;
    }

    .star {
      font-size: 20px;
      cursor: pointer;
      color: #ccc;
    }

    .star.active {
      color: #ffbf00;
    }

    .hidden {
      display: none !important;
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-weight: 600;
    }

    .alert-success {
      background: #e8fff1;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .alert-error {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3;
    }

    code {
      background: #f6f6f6;
      padding: 2px 6px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Learning Assistant Feedback System</h1>
      <p>Computer Science & Computer Engineering — University of Nebraska–Lincoln</p>
    </div>

    <div class="main-content">
      <!-- whoami / logout -->
      <div id="user-info" class="user-info">
        <div>
          <span class="user-welcome">Welcome, <b id="user-name"></b>!</span>
        </div>
        <div style="display:flex; gap:8px;">
          <details id="change-pw-panel">
            <summary class="btn-ghost" style="padding:6px 10px;">Change Password</summary>
            <div
              style="background:#fff; border:1px solid #eee; padding:10px; border-radius:10px; margin-top:8px; width:320px;">
              <div class="form-group">
                <label for="cpw-current">Current password</label>
                <input id="cpw-current" type="password" autocomplete="current-password">
              </div>
              <div class="form-group">
                <label for="cpw-new">New password (min 8)</label>
                <input id="cpw-new" type="password" autocomplete="new-password">
              </div>
              <button id="btn-change-password" class="btn" style="width:100%;">Update password</button>
            </div>
          </details>
          <button id="logout-btn" class="btn btn-secondary">Log Out</button>
        </div>
      </div>

      <!-- tabs -->
      <div class="tab-container">
        <button class="tab active" onclick="showTab('student', this)">Feedback</button>
        <button class="tab" onclick="showTab('login', this)">Login</button>
        <!-- Dashboard tab starts hidden until login -->
        <button class="tab" id="dashboard-tab" onclick="showTab('dashboard', this)"
          style="display:none;">Dashboard</button>
      </div>

      <!-- Student feedback tab -->
      <div id="student" class="tab-content active">
        <h2 style="margin-bottom:10px;">Submit Feedback</h2>

        <form id="feedback-form">
          <div class="form-group">
            <label for="course">Course</label>
            <select id="course">
              <option value="">Select Course</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 155N</option>
              <option>CSCE 156</option>
            </select>
          </div>

          <div class="form-group">
            <label for="feedback-type">Type</label>
            <select id="feedback-type">
              <option>General</option>
              <option>Course</option>
              <option>TA</option>
            </select>
          </div>

          <div class="form-group">
            <label>Overall Rating</label>
            <div class="rating">
              <span class="star" data-rating="1">★</span>
              <span class="star" data-rating="2">★</span>
              <span class="star" data-rating="3">★</span>
              <span class="star" data-rating="4">★</span>
              <span class="star" data-rating="5">★</span>
            </div>
            <input type="hidden" id="rating-value" value="0">
          </div>

          <div class="form-group">
            <label for="feedback-text">Feedback Details</label>
            <textarea id="feedback-text" placeholder="Please provide detailed feedback..." required></textarea>
          </div>

          <div class="form-group">
            <label for="student-name">Your Name (Optional)</label>
            <input id="student-name" type="text" placeholder="Leave blank to stay anonymous" />
          </div>

          <div class="form-group">
            <label for="student-year">Academic Year</label>
            <select id="student-year">
              <option value="">Select Year (Optional)</option>
              <option>Freshman</option>
              <option>Sophomore</option>
              <option>Junior</option>
              <option>Senior</option>
              <option>Graduate</option>
            </select>
          </div>

          <button type="submit" class="btn">Submit Feedback</button>
        </form>
      </div>

      <!-- Login / Signup tab -->
      <div id="login" class="tab-content">
        <div class="login-form" style="max-width:460px; margin:0 auto;">
          <h2 style="text-align:center; margin-bottom: 20px;">Sign in</h2>
          <div class="form-group">
            <label for="login-id">NUID or Email</label>
            <input id="login-id" type="text" placeholder="e.g., 64636271 or student@unl.edu" autocomplete="username">
          </div>
          <div class="form-group">
            <label for="login-pw">Password</label>
            <input id="login-pw" type="password" placeholder="Your password" autocomplete="current-password">
          </div>
          <button id="btn-login" class="btn" style="width:100%;">Sign in</button>

          <details style="margin-top:16px;">
            <summary><b>New student?</b> Create an account</summary>
            <div class="form-group" style="margin-top:10px;">
              <label for="su-name">Full name</label>
              <input id="su-name" type="text" placeholder="First Last">
            </div>
            <div class="form-group">
              <label for="su-email">Email</label>
              <input id="su-email" type="email" placeholder="you@unl.edu">
            </div>
            <div class="form-group">
              <label for="su-nuid">NUID (optional)</label>
              <input id="su-nuid" type="text" placeholder="e.g., 64636271">
            </div>
            <div class="form-group">
              <label for="su-pw">Password (min 8)</label>
              <input id="su-pw" type="password" placeholder="Create a password">
            </div>
            <div class="form-group">
              <label for="su-year">Class year</label>
              <select id="su-year">
                <option value="">Select Year</option>
                <option>Freshman</option>
                <option>Sophomore</option>
                <option>Junior</option>
                <option>Senior</option>
                <option>Graduate</option>
              </select>
            </div>
            <div class="form-group">
              <label for="su-courses">Courses (comma-separated)</label>
              <input id="su-courses" type="text" placeholder="CSCE 155A, CSCE 156">
            </div>
            <button id="btn-student-signup" class="btn" style="width:100%;">Create account</button>
          </details>
        </div>
      </div>

      <!-- Dashboard tab (hidden until login) -->
      <div id="dashboard" class="tab-content">
        <h2 style="margin-bottom:10px;">Dashboard</h2>

        <div class="grid grid-3" style="margin: 8px 0 16px;">
          <div class="stat-card">
            <div class="stat-number" id="total-feedback">0</div>
            <div>Total Feedback</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avg-rating">0.0</div>
            <div>Average Rating</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="this-week">0</div>
            <div>This Week</div>
          </div>
        </div>

        <div class="form-group">
          <label for="filter-course">Filter by Course</label>
          <select id="filter-course">
            <option value="">All Courses</option>
            <option>CSCE 101</option>
            <option>CSCE 155A</option>
            <option>CSCE 155E</option>
            <option>CSCE 155H</option>
            <option>CSCE 155N</option>
            <option>CSCE 156</option>
          </select>
        </div>

        <div class="feedback-list" id="feedback-list"></div>

        <!-- Staff schedule -->
        <div id="schedule-panel" class="hidden" style="margin-top: 22px;">
          <h3>My Schedule</h3>
          <table id="schedule-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Type</th>
                <th>Day</th>
                <th>Start</th>
                <th>End</th>
                <th>Location</th>
                <th>Course</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- SL Admin: pending student approvals -->
        <div id="admin-pending" class="hidden" style="margin-top:22px;">
          <h3>Pending student signups</h3>
          <div id="pending-rows"></div>
        </div>

        <!-- SL Admin: quick add staff -->
        <div id="admin-add-staff" class="hidden" style="margin-top:22px;">
          <h3>Add staff</h3>
          <div class="grid" style="grid-template-columns: repeat(2,minmax(0,1fr));">
            <div class="form-group"><label>NUID</label><input id="st-nuid" type="text" placeholder="e.g., 64636271">
            </div>
            <div class="form-group"><label>Name</label><input id="st-name" type="text" placeholder="Full name"></div>
            <div class="form-group">
              <label>Role</label>
              <select id="st-role">
                <option>LA</option>
                <option>CL</option>
                <option>SL</option>
              </select>
            </div>
            <div class="form-group"><label>Email (optional)</label><input id="st-email" type="email"></div>
            <div class="form-group"><label>Temp password (optional)</label><input id="st-pass" type="password"></div>
            <div class="form-group"><label>Courses (comma-separated)</label><input id="st-courses" type="text"></div>
          </div>
          <button id="btn-add-staff" class="btn">Add staff</button>
        </div>

        <!-- SL Admin: reset staff password -->
        <div id="admin-reset-staff" class="hidden" style="margin-top:22px;">
          <h3>Reset staff password</h3>
          <div class="grid" style="grid-template-columns: repeat(2,minmax(0,1fr));">
            <div class="form-group"><label>Staff NUID</label><input id="rst-nuid" type="text"
                placeholder="e.g., 64636271"></div>
            <div class="form-group"><label>New temp password</label><input id="rst-pass" type="password"></div>
          </div>
          <button id="btn-reset-staff" class="btn">Reset password</button>
        </div>

        <!-- SL Admin: bulk import staff -->
        <div id="admin-bulk" class="hidden" style="margin-top:22px;">
          <h3>Bulk import staff (CSV)</h3>
          <p style="margin:6px 0 8px;">Format (no header needed): <code>nuid,name,role,email,password</code></p>
          <textarea id="bulk-csv" rows="6" style="width:100%;"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="btn-bulk-upload" class="btn">Upload</button>
            <button id="btn-bulk-clear" class="btn btn-secondary" type="button">Clear</button>
          </div>
          <small>Tip: paste from your spreadsheet. We hash on the server; plaintext never gets stored.</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Helper UI bits =====
    function showAlert(message, kind = 'success') {
      const div = document.createElement('div');
      div.className = 'alert ' + (kind === 'success' ? 'alert-success' : 'alert-error');
      div.textContent = message;
      const cont = document.querySelector('.main-content') || document.body;
      cont.prepend(div);
      setTimeout(() => div.remove(), 4500);
    }
    function showTab(id, clicked) {
      document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.getElementById(id)?.classList.add('active');
      clicked?.classList.add('active');
    }
    function setVisible(el, on) {
      if (!el) return;
      el.classList[on ? 'remove' : 'add']('hidden');
      el.style.display = on ? '' : 'none';
    }

    // ===== Auth state (JWT) =====
    let authToken = localStorage.getItem('authToken') || null;
    let currentUser = null;
    try { currentUser = JSON.parse(localStorage.getItem('user') || 'null'); } catch { currentUser = null; }
    function authHeaders() {
      const t = authToken || localStorage.getItem('authToken');
      return t ? { 'Content-Type': 'application/json', 'Authorization': `Bearer ${t}` } : { 'Content-Type': 'application/json' };
    }
    function refreshWhoAmI() {
      const userInfo = document.getElementById('user-info');
      const nameEl = document.getElementById('user-name');
      const dashTab = document.getElementById('dashboard-tab');
      const isLogged = !!(authToken && currentUser);
      setVisible(userInfo, isLogged);
      setVisible(dashTab, isLogged); // show Dashboard tab only if logged in
      if (isLogged && nameEl) {
        nameEl.textContent = currentUser.name + (currentUser.kind === 'staff' ? ` (${currentUser.role})` : ' (student)');
      }
    }

    // ===== Rating stars =====
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', () => {
          const val = Number(star.dataset.rating);
          document.getElementById('rating-value').value = String(val);
          document.querySelectorAll('.star').forEach(s => s.classList.toggle('active', Number(s.dataset.rating) <= val));
        });
      });
    });

    // ===== Dashboard data =====
    let feedbackData = [];
    async function loadFeedback() {
      try {
        const r = await fetch('/api/feedback');
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Failed to load feedback');
        feedbackData = data || [];
        updateDashboard();
      } catch (e) {
        feedbackData = [];
        updateDashboard();
        showAlert(e.message || 'Failed to load feedback', 'error');
      }
    }
    function updateDashboard() {
      const total = feedbackData.length;
      const rated = feedbackData.filter(x => (x.rating ?? null) !== null);
      const avg = rated.length ? (rated.reduce((a, b) => a + (b.rating || 0), 0) / rated.length) : 0;
      const weekAgo = Date.now() - 7 * 24 * 3600 * 1000;
      const thisWeek = feedbackData.filter(x => new Date(x.created_at || Date.now()).getTime() >= weekAgo).length;
      document.getElementById('total-feedback').textContent = total;
      document.getElementById('avg-rating').textContent = avg.toFixed(1);
      document.getElementById('this-week').textContent = thisWeek;

      const filterCourse = document.getElementById('filter-course')?.value || '';
      const list = document.getElementById('feedback-list');
      if (!list) return;
      list.innerHTML = '';
      const items = feedbackData.filter(x => !filterCourse || x.course === filterCourse);
      if (!items.length) { list.innerHTML = '<div class="feedback-card">No feedback yet.</div>'; return; }

      items.forEach(item => {
        const card = document.createElement('div'); card.className = 'feedback-card';
        const head = document.createElement('div'); head.className = 'feedback-header';
        const meta = document.createElement('div'); meta.className = 'feedback-meta';
        meta.textContent = [
          item.course || 'General',
          item.type || 'General',
          item.created_at ? new Date(item.created_at).toLocaleString() : ''
        ].filter(Boolean).join(' • ');
        const rating = document.createElement('div'); rating.textContent = item.rating ? `★ ${item.rating}/5` : '';
        head.append(meta, rating);
        const body = document.createElement('div'); body.className = 'feedback-content';
        body.textContent = item.text || '';
        card.append(head, body);
        list.append(card);
      });
    }

    // ===== Submit feedback (auth required) =====
    document.getElementById('feedback-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const course = document.getElementById('course').value.trim();
      const type = document.getElementById('feedback-type').value.trim() || 'General';
      const rating = Number(document.getElementById('rating-value').value || 0) || null;
      const text = document.getElementById('feedback-text').value.trim();
      const submitter = document.getElementById('student-name').value.trim();
      const year = document.getElementById('student-year').value.trim();
      if (!text) return showAlert('Please enter feedback text.', 'error');
      try {
        const r = await fetch('/api/feedback', {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ course: course || null, type, rating, text, submitter: submitter || null, year: year || null })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Could not submit');
        showAlert('Thanks for your feedback!');
        document.getElementById('feedback-form').reset();
        document.getElementById('rating-value').value = '0';
        document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
      } catch (e) {
        if (/401/.test(String(e))) showAlert('Please sign in first.', 'error');
        else showAlert(e.message, 'error');
      }
    });

    // ===== Login / Logout =====
    document.getElementById('btn-login')?.addEventListener('click', async () => {
      const login = document.getElementById('login-id').value.trim();
      const password = document.getElementById('login-pw').value;
      if (!login || !password) return showAlert('Enter login and password.', 'error');
      try {
        const r = await fetch('/api/auth/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login, password })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Login failed');
        authToken = data.token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('user', JSON.stringify(currentUser));
        refreshWhoAmI();

        // Show Dashboard on login, load data, and switch to it
        setVisible(document.getElementById('dashboard-tab'), true);
        await loadFeedback();
        showTab('dashboard', document.getElementById('dashboard-tab'));

        // Protected bits
        if (currentUser.kind === 'staff') {
          await loadMySchedule();
          const isSL = currentUser.role === 'SL';
          showSLPanels(isSL);
          if (isSL) loadPendingStudents();
        }
        showAlert(`Welcome, ${currentUser.name}!`);
      } catch (e) {
        showAlert(e.message, 'error');
      }
    });

    document.getElementById('logout-btn')?.addEventListener('click', () => {
      localStorage.removeItem('authToken'); localStorage.removeItem('user');
      authToken = null; currentUser = null;
      refreshWhoAmI();
      setVisible(document.getElementById('dashboard-tab'), false);
      showTab('student', document.querySelector('.tab-container .tab')); // back to Feedback
      showSLPanels(false);
      setVisible(document.getElementById('schedule-panel'), false);
      showAlert('You have been logged out.');
    });

    // ===== Student signup =====
    document.getElementById('btn-student-signup')?.addEventListener('click', async () => {
      const name = document.getElementById('su-name').value.trim();
      const email = document.getElementById('su-email').value.trim().toLowerCase();
      const nuid = document.getElementById('su-nuid').value.trim();
      const password = document.getElementById('su-pw').value;
      const class_year = document.getElementById('su-year').value.trim();
      const courses = (document.getElementById('su-courses').value || '')
        .split(',').map(s => s.trim()).filter(Boolean);
      if (!name || !email || !password) return showAlert('Name, email, and password are required.', 'error');
      try {
        const r = await fetch('/api/auth/student/signup', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, nuid, password, class_year, courses })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Signup failed');
        showAlert('Submitted for SL approval. You can log in after approval.');
      } catch (e) { showAlert(e.message, 'error'); }
    });

    // ===== Change-my-password (auth) =====
    document.getElementById('btn-change-password')?.addEventListener('click', async () => {
      const oldPw = document.getElementById('cpw-current').value;
      const newPw = document.getElementById('cpw-new').value;
      if (!oldPw || !newPw) return showAlert('Enter both current and new password.', 'error');
      if (newPw.length < 8) return showAlert('New password must be at least 8 characters.', 'error');
      try {
        const r = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ current_password: oldPw, new_password: newPw })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Could not change password');
        showAlert('Password updated. Please log in again.');
        // Force logout after password change
        localStorage.removeItem('authToken'); localStorage.removeItem('user');
        authToken = null; currentUser = null;
        refreshWhoAmI();
        setVisible(document.getElementById('dashboard-tab'), false);
        showTab('login', document.querySelector('.tab-container .tab:nth-child(2)'));
      } catch (e) {
        showAlert(e.message, 'error');
      }
    });

    // ===== Admin & Schedule helpers =====
    function showSLPanels(isSL) {
      ['admin-pending', 'admin-add-staff', 'admin-reset-staff', 'admin-bulk']
        .forEach(id => setVisible(document.getElementById(id), !!isSL));
    }

    async function loadPendingStudents() {
      try {
        const r = await fetch('/api/auth/students/pending', { headers: authHeaders() });
        const rows = await r.json();
        const box = document.getElementById('pending-rows');
        if (!r.ok) throw new Error(rows.error || 'Failed');
        if (!rows.length) { box.innerHTML = '<div class="feedback-card">No pending students.</div>'; return; }
        box.innerHTML = rows.map(r => `
          <div class="feedback-card">
            <div class="feedback-header">
              <div class="feedback-meta"><b>${r.name}</b> — ${r.email} ${r.nuid ? `(${r.nuid})` : ''} ${r.class_year ? `— ${r.class_year}` : ''}</div>
              <div>
                <button class="btn-ghost" data-act="approve" data-id="${r.id}">Approve</button>
                <button class="btn-ghost" data-act="reject"  data-id="${r.id}">Reject</button>
              </div>
            </div>
          </div>
        `).join('');
        box.querySelectorAll('button[data-act]').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            const act = btn.getAttribute('data-act');
            const r2 = await fetch(`/api/auth/students/${id}/${act}`, { method: 'POST', headers: authHeaders() });
            const j = await r2.json().catch(() => ({}));
            if (!r2.ok) return showAlert(j.error || 'Action failed', 'error');
            showAlert('Updated.');
            loadPendingStudents();
          };
        });
      } catch (e) { showAlert(e.message, 'error'); }
    }

    async function loadMySchedule() {
      if (!currentUser || currentUser.kind !== 'staff') return;
      const tBody = document.querySelector('#schedule-table tbody');
      if (!tBody) return;
      tBody.innerHTML = '<tr><td colspan="6">Loading…</td></tr>';
      try {
        const r = await fetch(`/api/staff/${currentUser.nuid}/schedule`, { headers: authHeaders() });
        const rows = await r.json();
        if (!r.ok) throw new Error(rows.error || 'Failed');
        setVisible(document.getElementById('schedule-panel'), true);
        if (!rows.length) { tBody.innerHTML = '<tr><td colspan="6">No entries</td></tr>'; return; }
        tBody.innerHTML = rows.map(x => `
          <tr>
            <td>${x.type}</td><td>${x.day}</td><td>${x.start_time}</td>
            <td>${x.end_time}</td><td>${x.location || ''}</td><td>${x.course || ''}</td>
          </tr>
        `).join('');
      } catch (e) {
        setVisible(document.getElementById('schedule-panel'), false);
        showAlert(e.message, 'error');
      }
    }

    // Bulk CSV helpers
    function csvToItems(csv) {
      return (csv || '')
        .split('\n')
        .map(l => l.trim())
        .filter(Boolean)
        .map(line => {
          const [nuid, name, role, email, password] = line.split(',').map(s => (s ?? '').trim());
          return { nuid, name, role, email, password };
        })
        .filter(r => r.nuid);
    }

    document.getElementById('btn-bulk-upload')?.addEventListener('click', async () => {
      const txt = document.getElementById('bulk-csv')?.value || '';
      const items = csvToItems(txt);
      if (!items.length) return showAlert('Paste CSV: nuid,name,role,email,password', 'error');
      try {
        const r = await fetch('/api/staff/bulk/upsert', {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify(items)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Bulk import failed');
        showAlert(`Imported/updated ${data.count} staff.`);
        document.getElementById('bulk-csv').value = ''; // clear plaintext
      } catch (e) {
        showAlert(e.message, 'error');
      }
    });

    document.getElementById('btn-bulk-clear')?.addEventListener('click', () => {
      const ta = document.getElementById('bulk-csv');
      if (ta) ta.value = '';
    });

    document.getElementById('btn-reset-staff')?.addEventListener('click', async () => {
      const nuid = (document.getElementById('rst-nuid')?.value || '').trim();
      const pw = (document.getElementById('rst-pass')?.value || '');
      if (!nuid || !pw) return showAlert('Enter NUID and a new temp password.', 'error');
      try {
        const r = await fetch(`/api/staff/${nuid}`, {
          method: 'PUT',
          headers: authHeaders(),
          body: JSON.stringify({ reset_password_to: pw })
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data.error || 'Reset failed');
        showAlert('Password reset. Tell the staff member to log in and change it.');
        document.getElementById('rst-pass').value = '';
      } catch (e) {
        showAlert(e.message, 'error');
      }
    });

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', async () => {
      refreshWhoAmI();
      // Dashboard remains hidden until login (tab button hidden)
      document.getElementById('filter-course')?.addEventListener('change', updateDashboard);

      if (authToken && currentUser) {
        setVisible(document.getElementById('dashboard-tab'), true);
        await loadFeedback();
        if (currentUser.kind === 'staff') {
          await loadMySchedule();
          const isSL = currentUser.role === 'SL';
          showSLPanels(isSL);
          if (isSL) loadPendingStudents();
        }
      }
    });
  </script>
</body>

</html>